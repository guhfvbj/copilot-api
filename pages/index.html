<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Copilot 用量面板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+SC:wght@400;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/lucide-react@0.378.0/dist/umd/lucide.min.js"></script>
    <style>
      body {
        font-family: "Inter", "Noto Sans SC", system-ui, sans-serif;
        background: radial-gradient(circle at 20% 20%, #e0f2fe 0, #f8fafc 40%, #f4f7fb 100%);
        color: #0f172a;
      }
      .card {
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.92);
        border: 1px solid rgba(255, 255, 255, 0.7);
        border-radius: 18px;
        box-shadow: 0 20px 60px rgba(15, 23, 42, 0.08);
      }
      .pill {
        padding: 2px 8px;
        border-radius: 999px;
        background: #e2e8f0;
        font-size: 12px;
        color: #1f2937;
      }
      .mono {
        font-family: "JetBrains Mono", monospace;
      }
    </style>
  </head>
  <body class="min-h-screen">
    <header class="card mx-auto max-w-6xl mt-6 px-6 py-4 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="p-2 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 text-white shadow-md">
          <i class="lucide lucide-layout-dashboard h-5 w-5"></i>
        </div>
        <div>
          <h1 class="text-xl font-bold">Copilot 用量面板</h1>
          <p class="text-sm text-slate-500">同域调用 /usage /token /accounts</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <div id="account-selector-container" class="hidden md:block"></div>
        <button id="add-account-btn" class="px-4 py-2 rounded-lg bg-slate-900 text-white text-sm flex items-center gap-1">
          <i class="lucide lucide-plus h-4 w-4"></i><span>添加账号</span>
        </button>
        <button id="refresh-btn" class="p-2 rounded-lg border border-slate-200 text-slate-600 hover:text-blue-600">
          <i class="lucide lucide-refresh-cw h-5 w-5"></i>
        </button>
      </div>
    </header>

    <div class="md:hidden mx-auto max-w-6xl px-4 mt-3" id="mobile-selector-container"></div>

    <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
      <div class="grid gap-4 md:grid-cols-2">
        <div class="card p-4 flex items-center gap-3">
          <i class="lucide lucide-server h-5 w-5 text-blue-600"></i>
          <div>
            <div class="text-xs text-slate-500 uppercase">请求地址</div>
            <div id="current-endpoint" class="mono text-sm text-slate-800 truncate"></div>
          </div>
        </div>

        <div class="card p-4 space-y-3">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-xs text-slate-500 uppercase">统一 API Key</div>
              <div class="text-sm text-slate-700">用于多账号粘滞轮询调用</div>
            </div>
            <div class="flex gap-2">
              <button id="generate-key-btn" class="px-3 py-2 rounded-lg bg-blue-600 text-white text-sm">生成</button>
              <button id="copy-key-btn" class="px-3 py-2 rounded-lg border border-slate-200 text-sm">复制</button>
            </div>
          </div>
          <div class="border border-dashed border-slate-200 rounded-lg p-3 bg-slate-50">
            <div class="text-xs text-slate-500 mb-1">当前 Key</div>
            <div id="api-key-value" class="mono break-all text-sm text-slate-800">暂无</div>
          </div>
          <div id="api-key-status" class="text-xs text-slate-500"></div>
          <div class="text-xs text-slate-500">
            说明：客户端使用 <span class="mono">Authorization: Bearer &lt;key&gt;</span> 或 <span class="mono">X-API-Key</span>。
            未提供 <span class="mono">X-Conversation-Id</span> 时默认按 Key 粘滞到同一账号，新的对话 ID 会切换到下一个账号。
          </div>
        </div>
      </div>

      <div id="content-area" class="min-h-[320px] card p-6">
        <div class="text-center text-slate-500">正在加载...</div>
      </div>
    </main>

    <!-- 添加账号弹窗 -->
    <div id="add-modal" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 bg-slate-900/60"></div>
      <div class="relative z-10 flex items-center justify-center min-h-screen px-4">
        <div class="card w-full max-w-lg p-6 space-y-4">
          <div class="flex justify-between items-center">
            <h3 class="text-lg font-bold">添加账号</h3>
            <button id="modal-close" class="text-slate-400 hover:text-slate-700">
              <i class="lucide lucide-x h-5 w-5"></i>
            </button>
          </div>
          <div class="space-y-3">
            <div>
              <label class="text-sm text-slate-600">GitHub Token</label>
              <input id="token-input" class="w-full border border-slate-200 rounded-lg px-3 py-2 mt-1 text-sm mono" placeholder="ghp_xxx" />
            </div>
            <div>
              <label class="text-sm text-slate-600">账号类型</label>
              <select id="account-type" class="w-full border border-slate-200 rounded-lg px-3 py-2 mt-1 text-sm">
                <option value="individual">individual</option>
                <option value="business">business</option>
                <option value="enterprise">enterprise</option>
              </select>
            </div>
            <div id="modal-error" class="hidden text-sm text-red-600 bg-red-50 border border-red-100 rounded-lg px-3 py-2"></div>
          </div>
          <div class="flex gap-2">
            <button id="modal-cancel" class="flex-1 border border-slate-200 rounded-lg py-2 text-sm">取消</button>
            <button id="modal-submit" class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg py-2 text-sm">提交</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const BASE = `${window.location.protocol}//${window.location.host}`;
      const USAGE_URL = `${BASE}/usage`;
      const TOKEN_URL = `${BASE}/token`;
      const ACCOUNT_URL = `${BASE}/accounts`;
      const API_KEY_URL = `${BASE}/api-keys`;

      const state = { isLoading: false, error: null, data: null, accounts: [], accountId: "", apiKey: "" };

      const contentArea = document.getElementById("content-area");
      const refreshBtn = document.getElementById("refresh-btn");
      const addAccountBtn = document.getElementById("add-account-btn");
      const endpointLabel = document.getElementById("current-endpoint");
      const accountSelectorContainer = document.getElementById("account-selector-container");
      const mobileSelectorContainer = document.getElementById("mobile-selector-container");
      const apiKeyValueEl = document.getElementById("api-key-value");
      const apiKeyStatusEl = document.getElementById("api-key-status");
      const generateKeyBtn = document.getElementById("generate-key-btn");
      const copyKeyBtn = document.getElementById("copy-key-btn");

      const modal = document.getElementById("add-modal");
      const modalError = document.getElementById("modal-error");

      const LABELS = {
        chat: "对话 (Chat)",
        completions: "补全 (Completions)",
        premium_interactions: "高级交互 (Premium)",
        entitlement: "总配额",
        quota_remaining: "剩余额度",
        remaining: "剩余额度",
        percent_remaining: "剩余百分比",
        quota_reset_date: "重置时间",
        quota_reset_date_utc: "重置时间 (UTC)",
        access_type_sku: "套餐 SKU",
        copilot_plan: "Copilot 方案",
      };

      const formatDate = (v) => {
        const d = new Date(v);
        if (Number.isNaN(d.getTime())) return v;
        const pad = (n) => n.toString().padStart(2, "0");
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      };

      function renderSelector() {
        const count = state.accounts.length;
        if (!count) {
          accountSelectorContainer.innerHTML = "";
          mobileSelectorContainer.innerHTML = "";
          return;
        }
        const opts = state.accounts
          .map((a) => `<option value="${a.id}" ${state.accountId === a.id ? "selected" : ""}>${a.id}${a.accountType ? ` (${a.accountType})` : ""}</option>`)
          .join("");
        const html = `
          <div class="flex items-center gap-2">
            <span class="pill">共 ${count} 个</span>
            <select id="account-select" class="border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white">
              <option value="">自动(首账号)</option>
              ${opts}
            </select>
          </div>`;
        accountSelectorContainer.innerHTML = html;
        mobileSelectorContainer.innerHTML = html.replace("account-select", "account-select-mobile");
        const hook = (id) => {
          const el = document.getElementById(id);
          if (!el) return;
          el.onchange = (e) => {
            state.accountId = e.target.value;
            fetchAll();
          };
        };
        hook("account-select");
        hook("account-select-mobile");
      }

      function renderError(msg) {
        contentArea.innerHTML = `
          <div class="text-center text-red-600 bg-red-50 border border-red-100 rounded-lg py-4">${msg}</div>
        `;
      }

      function renderLoading() {
        contentArea.innerHTML = `<div class="text-center text-slate-500">加载中...</div>`;
      }

      function renderQuotaCards(quota) {
        return `
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            ${Object.entries(quota)
              .map(([key, detail]) => {
                const total = detail.entitlement ?? 0;
                const remaining = detail.quota_remaining ?? detail.remaining ?? 0;
                const unlimited = detail.unlimited === true || total === 0;
                const percentRemaining = detail.percent_remaining ?? (total > 0 ? (remaining / total) * 100 : 100);
                const percentUsed = unlimited ? 0 : 100 - percentRemaining;
                return `
                  <div class="card p-4 space-y-2">
                    <div class="flex justify-between items-center">
                      <div class="font-semibold">${LABELS[key] || key}</div>
                      <span class="pill">${unlimited ? "无限" : `${percentUsed.toFixed(1)}% 已用`}</span>
                    </div>
                    <div class="text-sm text-slate-500">总配额：${unlimited ? "∞" : total}</div>
                    <div class="text-sm text-slate-500">剩余：${unlimited ? "∞" : remaining}</div>
                    <div class="w-full h-2 bg-slate-200 rounded-full overflow-hidden">
                      <div class="h-2 bg-gradient-to-r from-blue-500 to-indigo-500" style="width:${unlimited ? 100 : percentUsed}%"></div>
                    </div>
                  </div>
                `;
              })
              .join("")}
          </div>`;
      }

      function renderDetails(data) {
        const entries = [];
        for (const [key, val] of Object.entries(data)) {
          if (key === "quota_snapshots") continue;
          if (key === "account") continue;
          let display = val;
          if (typeof val === "boolean") display = val ? "是" : "否";
          if (typeof val === "number" && key.includes("percent")) display = `${val.toFixed(1)}%`;
          if (typeof val === "string" && val.match(/\d{4}-\d{2}-\d{2}/)) display = formatDate(val);
          entries.push({ key, val: display });
        }
        if (!entries.length) return "";
        return `
          <div class="card p-4 space-y-2">
            <div class="font-semibold flex items-center gap-2">
              <i class="lucide lucide-file-text h-4 w-4 text-blue-500"></i> 详细数据
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
              ${entries
                .map(
                  (e) => `
                  <div class="border border-slate-100 rounded-lg p-2">
                    <div class="text-xs text-slate-500">${LABELS[e.key] || e.key}</div>
                    <div class="text-sm text-slate-800 break-all">${e.val}</div>
                  </div>`,
                )
                .join("")}
            </div>
          </div>
        `;
      }

      function renderData() {
        if (!state.data) return;
        const quota = state.data.quota_snapshots || {};
        contentArea.innerHTML = `
          ${state.data.account ? `<div class="mb-3 text-sm text-slate-600">当前账号：<span class="mono text-blue-600">${state.data.account}</span></div>` : ""}
          ${renderQuotaCards(quota)}
          <div class="mt-4">${renderDetails(state.data)}</div>
        `;
        if (typeof lucide !== "undefined") lucide.createIcons();
      }

      function renderApiKey() {
        if (!apiKeyValueEl) return;
        if (!apiKeyStatusEl) return;
        if (state.apiKey) {
          apiKeyValueEl.textContent = state.apiKey;
          apiKeyStatusEl.textContent = "已加载，可直接复制或使用";
          if (copyKeyBtn) copyKeyBtn.disabled = false;
        } else {
          apiKeyValueEl.textContent = "暂无";
          apiKeyStatusEl.textContent = "点击生成将为账号池创建统一 API Key";
          if (copyKeyBtn) copyKeyBtn.disabled = true;
        }
      }

      async function fetchApiKeys() {
        try {
          const res = await fetch(API_KEY_URL);
          if (res.ok) {
            const json = await res.json();
            if (Array.isArray(json.apiKeys)) {
              const sorted = [...json.apiKeys].sort((a, b) => (b.createdAt ?? 0) - (a.createdAt ?? 0));
              if (sorted.length) state.apiKey = sorted[0].key;
            }
          }
        } catch (e) {
          console.warn("获取 API Key 失败", e);
        }
        renderApiKey();
      }

      async function generateApiKey() {
        try {
          if (apiKeyStatusEl) apiKeyStatusEl.textContent = "生成中...";
          if (generateKeyBtn) generateKeyBtn.disabled = true;
          const res = await fetch(API_KEY_URL, { method: "POST" });
          if (!res.ok) throw new Error(`生成失败：HTTP ${res.status}`);
          const json = await res.json();
          state.apiKey = json?.apiKey?.key || "";
          renderApiKey();
          await copyApiKey();
          if (apiKeyStatusEl) apiKeyStatusEl.textContent = "已生成并复制到剪贴板";
        } catch (e) {
          if (apiKeyStatusEl) apiKeyStatusEl.textContent = e.message || "生成失败";
        } finally {
          if (generateKeyBtn) generateKeyBtn.disabled = false;
        }
      }

      async function copyApiKey() {
        if (!state.apiKey) {
          if (apiKeyStatusEl) apiKeyStatusEl.textContent = "暂无可复制的 Key";
          return;
        }
        try {
          await navigator.clipboard.writeText(state.apiKey);
          if (apiKeyStatusEl) apiKeyStatusEl.textContent = "已复制";
        } catch (e) {
          if (apiKeyStatusEl) apiKeyStatusEl.textContent = "复制失败，请手动选择文本";
        }
      }

      async function fetchAccounts() {
        try {
          const res = await fetch(ACCOUNT_URL);
          if (res.ok) {
            const json = await res.json();
            if (Array.isArray(json.accounts)) {
              state.accounts = json.accounts.map((a) => ({ id: a.id || "unknown", accountType: a.accountType }));
            }
          }
          if (!state.accounts.length) {
            const tRes = await fetch(TOKEN_URL);
            if (tRes.ok) {
              const json = await tRes.json();
              if (Array.isArray(json.tokens)) {
                state.accounts = json.tokens.map((t) => ({ id: t.id || "unknown", accountType: t.accountType }));
              }
            }
          }
          if (!state.accountId && state.accounts.length) state.accountId = state.accounts[0].id;
        } catch (e) {
          console.warn("账户获取失败", e);
        }
      }

      async function addAccount(token, accountType) {
        const res = await fetch(ACCOUNT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ githubToken: token, accountType }),
        });
        if (!res.ok) throw new Error(`添加失败：${res.status}`);
        return res.json();
      }

      async function fetchUsage() {
        const headers = {};
        if (state.accountId) headers["X-Account-Id"] = state.accountId;
        const res = await fetch(USAGE_URL, { headers });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
      }

      async function fetchAll() {
        state.isLoading = true;
        state.error = null;
        renderLoading();
        try {
          await fetchAccounts();
          renderSelector();
          state.data = await fetchUsage();
          state.isLoading = false;
          renderData();
        } catch (err) {
          state.isLoading = false;
          state.error = err.message || "请求失败";
          renderError(state.error);
        }
      }

      function openModal() {
        modal.classList.remove("hidden");
      }
      function closeModal() {
        modal.classList.add("hidden");
        modalError.classList.add("hidden");
        document.getElementById("token-input").value = "";
      }

      function initModal() {
        document.getElementById("modal-close").onclick = closeModal;
        document.getElementById("modal-cancel").onclick = closeModal;
        modal.onclick = (e) => {
          if (e.target === modal || e.target.classList.contains("bg-slate-900/60")) closeModal();
        };
        document.getElementById("modal-submit").onclick = async () => {
          const token = document.getElementById("token-input").value.trim();
          const type = document.getElementById("account-type").value;
          if (!token) {
            modalError.textContent = "Token 不能为空";
            modalError.classList.remove("hidden");
            return;
          }
          modalError.classList.add("hidden");
          try {
            await addAccount(token, type);
            closeModal();
            await fetchAll();
          } catch (err) {
            modalError.textContent = err.message || "添加失败";
            modalError.classList.remove("hidden");
          }
        };
      }

      refreshBtn.onclick = () => {
        fetchApiKeys();
        fetchAll();
      };
      addAccountBtn.onclick = openModal;
      if (generateKeyBtn) generateKeyBtn.onclick = generateApiKey;
      if (copyKeyBtn) copyKeyBtn.onclick = copyApiKey;
      endpointLabel.textContent = USAGE_URL;
      initModal();
      fetchApiKeys().then(fetchAll);
    </script>
  </body>
</html>
