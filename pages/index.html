<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Copilot 用量面板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/lucide-react@0.378.0/dist/umd/lucide.min.js"></script>
    <style>
      body {
        font-family: "Inter", "PingFang SC", "Microsoft YaHei", sans-serif;
        background: radial-gradient(circle at 20% 20%, #1f2937 0, #0f172a 45%, #0b1223 100%);
        color: #e5e7eb;
      }
      .card {
        backdrop-filter: blur(12px);
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.45);
      }
      .glass {
        backdrop-filter: blur(14px);
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(139, 92, 246, 0.12));
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .progress {
        height: 10px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.08);
        overflow: hidden;
      }
      .progress > div {
        height: 100%;
        border-radius: 999px;
        transition: width 0.4s ease;
        background: linear-gradient(90deg, #22d3ee, #8b5cf6);
      }
      .pill {
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.08);
        font-size: 12px;
        color: #cbd5f5;
      }
      .btn {
        background: linear-gradient(135deg, #22d3ee, #8b5cf6);
        color: #0b1223;
        font-weight: 700;
        border-radius: 12px;
        padding: 10px 16px;
      }
      .btn:active {
        transform: translateY(1px);
      }
      .mono {
        font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
      }
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 16px;
        z-index: 50;
      }
      .modal.active {
        display: flex;
      }
    </style>
  </head>
  <body class="min-h-screen">
    <div class="max-w-6xl mx-auto px-4 py-8 space-y-6">
      <header class="flex flex-col gap-2 card p-6">
        <div class="flex items-center gap-3">
          <div class="p-2 rounded-xl glass">
            <i class="lucide lucide-gauge h-6 w-6 text-cyan-300"></i>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-white">Copilot 用量面板</h1>
            <p class="text-sm text-slate-300">
              前端与接口同域，直接调用 <span class="mono text-cyan-200">/usage</span> 与
              <span class="mono text-cyan-200">/token</span>
            </p>
          </div>
        </div>
      </header>

      <section class="card p-5 space-y-4">
        <div class="flex flex-col sm:flex-row sm:items-center gap-3">
          <div class="flex items-center gap-2">
            <i class="lucide lucide-server h-5 w-5 text-cyan-300"></i>
            <div>
              <div class="text-xs uppercase tracking-wide text-slate-400">请求地址</div>
              <div class="mono text-sm text-cyan-100" id="current-endpoint"></div>
            </div>
          </div>
          <div class="flex-1"></div>
          <div class="flex gap-2">
            <button id="add-account-btn" class="btn flex items-center gap-2 self-start">
              <i class="lucide lucide-plus h-4 w-4"></i>
              <span>添加账号</span>
            </button>
            <button id="refresh-btn" class="btn flex items-center gap-2 self-start">
              <i class="lucide lucide-refresh-cw h-4 w-4"></i>
              <span>刷新</span>
            </button>
          </div>
        </div>
        <div id="account-selector"></div>
      </section>

      <div id="content-area" class="space-y-4"></div>
    </div>

    <div id="add-modal" class="modal">
      <div class="card p-6 w-full max-w-lg space-y-4">
        <div class="flex items-center justify-between">
          <div class="text-lg font-semibold text-white">手动添加账号</div>
          <button id="modal-close" class="text-slate-300 hover:text-white">
            <i class="lucide lucide-x h-5 w-5"></i>
          </button>
        </div>
        <div class="space-y-2">
          <label class="text-sm text-slate-300">GitHub Token</label>
          <input
            id="token-input"
            class="w-full bg-slate-900/80 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-cyan-400"
            placeholder="ghp_xxx"
          />
        </div>
        <div class="space-y-2">
          <label class="text-sm text-slate-300">账号类型</label>
          <select
            id="account-type"
            class="w-full bg-slate-900/80 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-cyan-400"
          >
            <option value="individual">individual</option>
            <option value="business">business</option>
            <option value="enterprise">enterprise</option>
          </select>
        </div>
        <div class="flex justify-end gap-2">
          <button id="modal-cancel" class="px-4 py-2 text-sm text-slate-200">取消</button>
          <button id="modal-submit" class="btn flex items-center gap-2">
            <i class="lucide lucide-save h-4 w-4"></i><span>提交</span>
          </button>
        </div>
        <div id="modal-error" class="text-sm text-red-300"></div>
      </div>
    </div>

    <script>
      const BASE = `${window.location.protocol}//${window.location.host}`;
      const USAGE_URL = `${BASE}/usage`;
      const TOKEN_URL = `${BASE}/token`;
      const ACCOUNT_URL = `${BASE}/accounts`;

      const state = {
        isLoading: false,
        error: null,
        data: null,
        accounts: [],
        accountId: "",
      };

      const contentArea = document.getElementById("content-area");
      const refreshBtn = document.getElementById("refresh-btn");
      const addAccountBtn = document.getElementById("add-account-btn");
      const endpointLabel = document.getElementById("current-endpoint");
      const accountSelectorSlot = document.getElementById("account-selector");
      const modal = document.getElementById("add-modal");

      function createIcons() {
        if (typeof lucide !== "undefined") lucide.createIcons();
      }

      function renderAccountSelector() {
        if (!state.accounts.length) {
          accountSelectorSlot.innerHTML = "";
          return;
        }
        const options = state.accounts
          .map(
            (acc) =>
              `<option value="${acc.id}" ${state.accountId === acc.id ? "selected" : ""}>${acc.id}</option>`,
          )
          .join("");
        accountSelectorSlot.innerHTML = `
          <label class="flex items-center gap-2 text-sm text-slate-200">
            <i class="lucide lucide-users h-4 w-4 text-cyan-300"></i>
            <span>选择账号</span>
            <select id="account-select" class="bg-slate-900/70 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-cyan-400">
              <option value="">自动(首账号)</option>
              ${options}
            </select>
          </label>
        `;
        const select = document.getElementById("account-select");
        select.onchange = () => {
          state.accountId = select.value;
          fetchAll();
        };
      }

      function renderError(message) {
        return `
          <div class="card border border-red-500/40 bg-red-500/10 p-5">
            <div class="flex items-center gap-2 text-red-300 font-semibold">
              <i class="lucide lucide-alert-triangle h-5 w-5"></i>
              <span>请求失败</span>
            </div>
            <div class="mt-2 text-sm text-red-200">${message}</div>
          </div>
        `;
      }

      function renderSpinner() {
        return `
          <div class="card p-6 flex justify-center">
            <div class="animate-spin h-10 w-10 rounded-full border-4 border-slate-700 border-t-cyan-300"></div>
          </div>
        `;
      }

      function renderQuotaCard(title, detail) {
        const { entitlement, remaining, percent_remaining, unlimited } = detail;
        const percentUsed = unlimited ? 0 : 100 - percent_remaining;
        const used = unlimited ? "无限" : entitlement - remaining;
        let color = "from-cyan-400 to-blue-500";
        if (!unlimited && percentUsed > 75) color = "from-amber-400 to-orange-500";
        if (!unlimited && percentUsed > 90) color = "from-rose-500 to-red-600";
        return `
          <div class="card p-4 space-y-3">
            <div class="flex justify-between items-center">
              <div class="text-sm text-slate-300 capitalize">${title.replace(/_/g, " ")}</div>
              <span class="pill">${unlimited ? "无限" : percentUsed.toFixed(1) + "% 已用"}</span>
            </div>
            <div class="progress">
              <div style="width:${unlimited ? 100 : percentUsed}%;" class="bg-gradient-to-r ${color}"></div>
            </div>
            <div class="flex justify-between text-xs text-slate-400 mono">
              <span>${used === "无限" ? "无限" : Number(used).toLocaleString()} / ${unlimited ? "无限" : entitlement.toLocaleString()}</span>
              <span>${unlimited ? "无限" : remaining.toLocaleString()} 剩余</span>
            </div>
          </div>
        `;
      }

      function formatMaybeDate(value) {
        if (typeof value !== "string") return null;
        const d = new Date(value);
        if (Number.isNaN(d.getTime())) return null;
        const pad = (n) => n.toString().padStart(2, "0");
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      }

      function formatObject(obj) {
        if (obj === null || typeof obj !== "object") {
          if (typeof obj === "string") {
            const formatted = formatMaybeDate(obj);
            return `<span class="text-cyan-200">${formatted ?? obj}</span>`;
          }
          if (typeof obj === "number") {
            return `<span class="text-cyan-200">${obj}</span>`;
          }
          return `<span class="text-cyan-200">${String(obj)}</span>`;
        }
        const labelMap = {
          account: "账号",
          access_type_sku: "套餐 SKU",
          analytics_tracking_id: "追踪 ID",
          assigned_date: "分配日期",
          can_signup_for_limited: "可注册精简版",
          chat_enabled: "聊天可用",
          copilot_plan: "Copilot 计划",
          organization_login_list: "组织登录列表",
          organization_list: "组织列表",
          quota_reset_date: "配额重置日期",
          quota_reset_date_utc: "配额重置 UTC",
          quota_snapshots: "配额快照",
          chat: "聊天",
          completions: "补全",
          premium_interactions: "高级交互",
          entitlement: "总配额",
          overage_count: "超量次数",
          overage_permitted: "允许超量",
          percent_remaining: "剩余百分比",
          quota_id: "配额 ID",
          quota_remaining: "剩余配额",
          remaining: "剩余",
          unlimited: "是否无限",
          timestamp_utc: "时间戳 UTC",
        };
        const entries = Object.entries(obj)
          .map(([k, v]) => {
            const label = labelMap[k] || k.replace(/_/g, " ");
            let val;
            if (Array.isArray(v)) {
              val = `<span class="text-slate-400">[ ${v.length} 项 ]</span>`;
            } else if (typeof v === "object") {
              val = formatObject(v);
            } else if (typeof v === "boolean") {
              val = `<span class="${v ? "text-green-300" : "text-red-300"} font-semibold">${v ? "是" : "否"}</span>`;
            } else {
              if (typeof v === "number" && k.includes("percent")) {
                val = `<span class="text-blue-200">${v.toFixed(1)}%</span>`;
              } else if (typeof v === "string") {
                const formatted = formatMaybeDate(v);
                val = `<span class="text-blue-200">${formatted ?? v}</span>`;
              } else {
                val = `<span class="text-blue-200">${String(v)}</span>`;
              }
            }
            return `
              <div class="flex flex-col gap-1 border border-white/5 rounded-lg p-2">
                <span class="text-slate-300 text-sm">${label}</span>
                <div class="pl-1 text-sm">${val}</div>
              </div>
            `;
          })
          .join("");
        return `<div class="grid md:grid-cols-2 gap-2">${entries}</div>`;
      }

      function renderDetailed(data) {
        return `
          <div class="card p-5 space-y-3">
            <div class="flex items-center gap-2 text-slate-200">
              <i class="lucide lucide-file-text h-5 w-5 text-cyan-300"></i>
              <span class="font-semibold">完整数据</span>
            </div>
            <div class="mono text-xs text-slate-200 space-y-2">${formatObject(data)}</div>
          </div>
        `;
      }

      function renderUsage(data) {
        if (!data?.quota_snapshots) return "";
        const cards = Object.entries(data.quota_snapshots)
          .map(([key, value]) => renderQuotaCard(key, value))
          .join("");
        return `
          <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
            ${cards}
          </div>
        `;
      }

      async function fetchAccounts() {
        try {
          const res = await fetch(TOKEN_URL);
          if (!res.ok) return;
          const json = await res.json();
          if (Array.isArray(json.tokens)) {
            state.accounts = json.tokens.map((t) => ({ id: t.id || "unknown" }));
            if (!state.accountId && state.accounts.length > 0) {
              state.accountId = state.accounts[0].id;
            }
          }
        } catch (e) {
          console.warn("账户列表获取失败:", e);
        }
      }

      async function addAccount(githubToken, accountType) {
        const res = await fetch(ACCOUNT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ githubToken, accountType }),
        });
        if (!res.ok) {
          throw new Error(`添加失败：${res.status} ${res.statusText}`);
        }
        return res.json();
      }

      async function fetchUsage() {
        const headers = {};
        if (state.accountId) headers["X-Account-Id"] = state.accountId;
        const res = await fetch(USAGE_URL, { headers });
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        return res.json();
      }

      async function fetchAll() {
        state.isLoading = true;
        state.error = null;
        render();
        try {
          await fetchAccounts();
          renderAccountSelector();
          const data = await fetchUsage();
          state.data = data;
        } catch (err) {
          state.error = err.message || "Failed to fetch";
          state.data = null;
        } finally {
          state.isLoading = false;
          render();
        }
      }

      function render() {
        if (state.isLoading) {
          contentArea.innerHTML = renderSpinner();
          createIcons();
          return;
        }
        if (state.error) {
          contentArea.innerHTML = renderError(state.error);
          createIcons();
          return;
        }
        if (state.data) {
          const accountInfo = state.data.account
            ? `<div class="text-sm text-slate-300">当前账号：<span class="mono text-cyan-200">${state.data.account}</span></div>`
            : "";
          contentArea.innerHTML = `
            <div class="flex flex-col lg:flex-row gap-4">
              <div class="flex-1 space-y-4">
                ${accountInfo}
                ${renderUsage(state.data)}
              </div>
            </div>
            ${renderDetailed(state.data)}
          `;
          createIcons();
          return;
        }
        contentArea.innerHTML = `
          <div class="card p-6 text-center text-slate-300">
            <div class="flex justify-center mb-2">
              <i class="lucide lucide-info h-6 w-6 text-cyan-300"></i>
            </div>
            <p>点击右上角「刷新」获取最新用量</p>
          </div>
        `;
        createIcons();
      }

      function initModal() {
        const close = () => modal.classList.remove("active");
        document.getElementById("modal-close").onclick = close;
        document.getElementById("modal-cancel").onclick = close;
        modal.onclick = (e) => {
          if (e.target === modal) close();
        };
        document.getElementById("modal-submit").onclick = async () => {
          const token = document.getElementById("token-input").value.trim();
          const type = document.getElementById("account-type").value;
          const errLabel = document.getElementById("modal-error");
          errLabel.textContent = "";
          if (!token) {
            errLabel.textContent = "Token 不能为空";
            return;
          }
          try {
            await addAccount(token, type);
            close();
            await fetchAll();
          } catch (err) {
            errLabel.textContent = err.message || "添加失败";
          }
        };
        addAccountBtn.onclick = () => modal.classList.add("active");
      }

      refreshBtn.onclick = fetchAll;
      endpointLabel.textContent = USAGE_URL;
      fetchAll();
      initModal();
    </script>
  </body>
</html>
