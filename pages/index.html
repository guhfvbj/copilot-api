<!doctype html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Copilot API Usage Dashboard</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <script src="https://unpkg.com/lucide-react@0.378.0/dist/umd/lucide.min.js"></script>

    <style>
      :root {
        --color-red: #cc241d;
        --color-green: #98971a;
        --color-yellow: #d79921;
        --color-blue: #458588;
        --color-purple: #b16286;
        --color-aqua: #689d6a;
        --color-orange: #d65d0e;
        --color-gray: #a89984;
        --color-red-accent: #fb4934;
        --color-green-accent: #b8bb26;
        --color-yellow-accent: #fabd2f;
        --color-blue-accent: #83a598;
        --color-purple-accent: #d3869b;
        --color-aqua-accent: #8ec07c;
        --color-orange-accent: #fe8019;
        --color-gray-accent: #928374;
        --color-bg-darkest: #1d2021;
        --color-bg: #282828;
        --color-bg-light-1: #3c3836;
        --color-bg-light-2: #504945;
        --color-bg-light-3: #665c54;
        --color-bg-light-4: #7c6f64;
        --color-bg-soft: #32302f;
        --color-fg-dark: #bdae93;
        --color-fg-medium: #d5c4a1;
        --color-fg-light: #ebdbb2;
        --color-fg-lightest: #fbf1c7;
      }
      body {
        font-family: "Inter", sans-serif;
        background-color: var(--color-bg-darkest);
        color: var(--color-fg-light);
      }
      .progress-bar-bg {
        background-color: var(--color-bg-light-1);
      }
      .progress-bar-fg {
        transition: width 0.5s ease-in-out;
      }
      .input-focus:focus {
        --tw-ring-color: var(--color-blue);
        border-color: var(--color-blue);
      }
    </style>
  </head>
  <body class="antialiased">
    <div id="app" class="min-h-screen p-4 sm:p-6">
      <div class="max-w-7xl mx-auto">
        <header class="mb-6">
          <h1
            class="text-2xl font-bold flex items-center gap-2"
            style="color: var(--color-fg-lightest)"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="lucide lucide-gauge-circle h-7 w-7"
              style="color: var(--color-aqua-accent)"
            >
              <path d="M15.6 3.3a10 10 0 1 0 5.1 5.1" />
              <path
                d="M12 12a1 1 0 0 0-1-1v4a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1h-3z"
              />
              <path d="M12 6.8a10 10 0 0 0 -3.2 7.2" />
            </svg>
            <span>Copilot API Usage Dashboard</span>
          </h1>
          <p class="mt-1 text-sm" style="color: var(--color-gray)">
            应与 VSCode 中的用量一致
          </p>
        </header>

        <div
          class="mb-6 p-4 border"
          style="
            background-color: var(--color-bg-soft);
            border-color: var(--color-bg-light-2);
          "
        >
          <form
            id="endpoint-form"
            class="flex flex-col sm:flex-row items-center gap-3"
          >
            <label
              for="endpoint-url"
              class="font-semibold whitespace-nowrap text-sm"
              style="color: var(--color-fg-lightest)"
              >API Endpoint URL</label
            >
            <input
              type="text"
              id="endpoint-url"
              class="w-full px-3 py-1.5 border focus:ring-1 transition input-focus text-sm"
              style="
                background-color: var(--color-bg-darkest);
                border-color: var(--color-bg-light-3);
                color: var(--color-fg-medium);
              "
              placeholder="http://localhost:4141/usage"
            />
            <button
              id="fetch-button"
              type="submit"
              class="w-full sm:w-auto font-bold py-1.5 px-5 transition-colors flex items-center justify-center gap-2 text-sm"
              style="
                background-color: var(--color-blue);
                color: var(--color-bg-darkest);
              "
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="lucide lucide-refresh-cw h-4 w-4"
              >
                <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" />
                <path d="M21 3v5h-5" />
                <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" />
                <path d="M3 21v-5h5" />
              </svg>
              <span>Fetch</span>
            </button>
          </form>
        </div>

        <main id="content-area"></main>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const endpointForm = document.getElementById("endpoint-form");
        const endpointUrlInput = document.getElementById("endpoint-url");
        const contentArea = document.getElementById("content-area");
        const fetchButton = document.getElementById("fetch-button");

        fetchButton.addEventListener("mouseenter", () => {
          fetchButton.style.backgroundColor = "var(--color-blue-accent)";
        });
        fetchButton.addEventListener("mouseleave", () => {
          fetchButton.style.backgroundColor = "var(--color-blue)";
        });

        const DEFAULT_ENDPOINT = "http://localhost:4141/usage";

        const state = {
          isLoading: false,
          error: null,
          data: null,
          accounts: [],
          accountId: "",
        };

        const getBaseUrl = (usageUrl) => {
          const url = new URL(usageUrl);
          return `${url.protocol}//${url.host}`;
        };

        function createIcons() {
          if (typeof lucide !== "undefined") {
            lucide.createIcons();
          }
        }

        function renderAccountSelector() {
          if (!state.accounts.length) return "";
          const options = state.accounts
            .map(
              (acc) =>
                `<option value="${acc.id}" ${state.accountId === acc.id ? "selected" : ""}>${acc.id}</option>`,
            )
            .join("");
          return `
            <div class="mb-4 flex flex-col sm:flex-row gap-3 items-center">
              <label class="font-semibold text-sm" style="color: var(--color-fg-lightest)">选择账号</label>
              <select id="account-select" class="w-full sm:w-64 px-3 py-1.5 border text-sm"
                style="background-color: var(--color-bg-darkest); border-color: var(--color-bg-light-3); color: var(--color-fg-medium);">
                <option value="">自动选择(首账号)</option>
                ${options}
              </select>
            </div>
          `;
        }

        function renderUsageQuotas(snapshots) {
          if (!snapshots) return "";
          const quotaCards = Object.entries(snapshots)
            .map(([key, value]) => renderQuotaCard(key, value))
            .join("");
          return `
            <section id="usage-quotas" class="mb-6">
              <h2 class="text-xl font-bold mb-3 flex items-center gap-2" style="color: var(--color-fg-lightest);">
                <i data-lucide="bar-chart-big"></i> 用量配额
              </h2>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                ${quotaCards}
              </div>
            </section>
          `;
        }

        function renderQuotaCard(title, details) {
          const { entitlement, remaining, percent_remaining, unlimited } = details;
          const percentUsed = unlimited ? 0 : 100 - percent_remaining;
          const used = unlimited ? "N/A" : (entitlement - remaining).toLocaleString();
          let progressBarColor = "var(--color-green)";
          if (percentUsed > 75) progressBarColor = "var(--color-yellow)";
          if (percentUsed > 90) progressBarColor = "var(--color-red)";
          if (unlimited) progressBarColor = "var(--color-blue)";
          return `
            <div class="p-4 border" style="background-color: var(--color-bg); border-color: var(--color-bg-light-2);">
              <div class="flex justify-between items-center mb-2">
                <h3 class="text-md font-semibold capitalize" style="color: var(--color-fg-lightest);">${title.replace(/_/g, " ")}</h3>
                ${
                  unlimited
                    ? `<span class="px-2 py-0.5 text-xs font-medium" style="color: var(--color-blue-accent); background-color: var(--color-bg-light-1);">Unlimited</span>`
                    : `<span class="text-sm font-mono" style="color: var(--color-fg-medium);">${percentUsed.toFixed(1)}% 已用</span>`
                }
              </div>
              <div class="mb-3">
                <div class="w-full progress-bar-bg h-2">
                  <div class="progress-bar-fg h-2" style="width: ${unlimited ? 100 : percentUsed}%; background-color: ${progressBarColor};"></div>
                </div>
              </div>
              <div class="flex justify-between text-xs font-mono" style="color: var(--color-fg-dark);">
                <span>${used} / ${unlimited ? "N/A" : entitlement.toLocaleString()}</span>
                <span>${unlimited ? "N/A" : remaining.toLocaleString()} 剩余</span>
              </div>
            </div>
          `;
        }

        function formatObject(obj) {
          if (obj === null || typeof obj !== "object") {
            return `<span style="color: var(--color-green-accent);">${JSON.stringify(obj)}</span>`;
          }
          return (
            '<div class="pl-4">' +
            Object.entries(obj)
              .map(([key, value]) => {
                const formattedKey = key.replace(/_/g, " ");
                let displayValue;
                if (Array.isArray(value)) {
                  displayValue =
                    value.length > 0
                      ? `<span style='color: var(--color-gray-accent)'>[...${value.length} items]</span>`
                      : `<span style='color: var(--color-gray-accent)'>[]</span>`;
                } else if (typeof value === "object" && value !== null) {
                  displayValue = formatObject(value);
                } else if (typeof value === "boolean") {
                  displayValue = `<span class="font-semibold" style="color: ${value ? "var(--color-green-accent)" : "var(--color-red-accent)"}">${value}</span>`;
                } else {
                  displayValue = `<span style="color: var(--color-blue-accent);">${JSON.stringify(value)}</span>`;
                }
                return `<div class="mt-1">
                  <span class="capitalize font-semibold" style="color: var(--color-fg-medium);">${formattedKey}:</span>
                  ${typeof value === "object" && value !== null && !Array.isArray(value) ? displayValue : ` ${displayValue}`}
                </div>`;
              })
              .join("") +
            "</div>"
          );
        }

        function renderDetailedData(data) {
          const formattedDetails = formatObject(data);
          return `
            <section id="detailed-data">
              <h2 class="text-xl font-bold mb-3 flex items-center gap-2" style="color: var(--color-fg-lightest);">
                <i data-lucide="file-text"></i> 详细信息
              </h2>
              <div class="border p-4 relative font-mono text-xs" style="background-color: var(--color-bg-darkest); border-color: var(--color-bg-light-2);">
                ${formattedDetails}
              </div>
            </section>
          `;
        }

        function renderSpinner() {
          return `
            <div class="flex justify-center items-center py-20">
              <div class="animate-spin h-12 w-12 rounded-full border-4 border-transparent border-t-4" style="border-top-color: var(--color-blue);"></div>
            </div>`;
        }

        function renderError(message) {
          const container = document.createElement("div");
          container.className = "p-3 border";
          container.style.backgroundColor = "rgba(204, 36, 29, 0.2)";
          container.style.borderColor = "var(--color-red)";
          container.style.color = "var(--color-red-accent)";
          container.setAttribute("role", "alert");
          container.innerHTML = `
            <div class="flex items-center">
              <i data-lucide="alert-triangle" class="h-5 w-5 mr-3"></i>
              <div>
                <p class="font-bold text-sm">请求异常</p>
                <p class="text-xs">${message}</p>
              </div>
            </div>
          `;
          setTimeout(() => lucide.createIcons({ nodes: [container.querySelector("[data-lucide]")] }), 0);
          return container.outerHTML;
        }

        function renderWelcomeMessage() {
          return `
            <div class="text-center py-16 px-4 border" style="background-color: var(--color-bg-soft); border-color: var(--color-bg-light-2);">
                <i data-lucide="info" class="mx-auto h-10 w-10" style="color: var(--color-gray-accent);"></i>
                <h3 class="mt-2 text-lg font-semibold" style="color: var(--color-fg-lightest);">欢迎！</h3>
                <p class="mt-1 text-sm" style="color: var(--color-gray);">输入 API endpoint 并点击 Fetch 查看用量数据。</p>
                <p class="mt-1 text-xs" style="color: var(--color-gray);">如在 HTTPS 页面访问本地 HTTP 接口，会被浏览器拦截，请改用 HTTPS 或将页面保存到本地打开。</p>
            </div>
          `;
        }

        function render() {
          const accountSelector = renderAccountSelector();
          if (state.isLoading) {
            contentArea.innerHTML = accountSelector + renderSpinner();
            createIcons();
            bindAccountSelector();
            return;
          }
          if (state.error) {
            contentArea.innerHTML = accountSelector + renderError(state.error);
          } else if (state.data) {
            const accountInfo = state.data.account
              ? `<div class="mb-3 text-sm" style="color: var(--color-gray);">当前账号：${state.data.account}</div>`
              : "";
            const endpointInfo = `
              <div class="mb-2 text-xs font-mono" style="color: var(--color-gray);">
                当前请求地址：<span style="color: var(--color-blue-accent);">${endpointUrlInput.value.trim()}</span>
              </div>
            `;
            contentArea.innerHTML = `
              ${accountSelector}
              ${endpointInfo}
              ${accountInfo}
              ${renderUsageQuotas(state.data.quota_snapshots)}
              ${renderDetailedData(state.data)}
            `;
          } else {
            contentArea.innerHTML = accountSelector + renderWelcomeMessage();
          }
          createIcons();
          bindAccountSelector();
        }

        function bindAccountSelector() {
          const select = document.getElementById("account-select");
          if (!select) return;
          select.onchange = () => {
            state.accountId = select.value;
            fetchData();
          };
        }

        async function fetchAccounts(baseUrl) {
          try {
            const res = await fetch(`${baseUrl}/token`);
            if (!res.ok) return;
            const json = await res.json();
            if (Array.isArray(json.tokens)) {
              state.accounts = json.tokens.map((t) => ({ id: t.id || "unknown" }));
            }
          } catch (e) {
            console.warn("账户列表获取失败：", e);
          }
        }

        async function fetchData() {
          const url = endpointUrlInput.value.trim();
          if (!url) {
            state.error = "Endpoint 不能为空";
            state.isLoading = false;
            render();
            return;
          }

          state.isLoading = true;
          state.error = null;
          render();

          try {
            const base = getBaseUrl(url);
            await fetchAccounts(base);

            const headers = {};
            if (state.accountId) headers["X-Account-Id"] = state.accountId;

            const response = await fetch(url, { headers });
            if (!response.ok) {
              throw new Error(`请求失败 ${response.status}: ${response.statusText}`);
            }
            state.data = await response.json();
          } catch (error) {
            console.error("Fetch error:", error);
            state.data = null;
            state.error = error.message;
          } finally {
            state.isLoading = false;
            render();
          }
        }

        function handleFormSubmit(event) {
          event.preventDefault();
          const url = endpointUrlInput.value.trim();
          try {
            const currentUrl = new URL(window.location);
            currentUrl.searchParams.set("endpoint", url);
            window.history.pushState({}, "", currentUrl);
          } catch (e) {
            console.warn("无法更新地址栏：", e.message);
          }
          fetchData();
        }

        function init() {
          endpointForm.addEventListener("submit", handleFormSubmit);
          const urlParams = new URLSearchParams(window.location.search);
          const endpointFromUrl = urlParams.get("endpoint");
          if (endpointFromUrl) {
            endpointUrlInput.value = endpointFromUrl;
            fetchData();
          } else {
            endpointUrlInput.value = DEFAULT_ENDPOINT;
            render();
          }
        }

        init();
      });
    </script>

    <footer
      class="text-center py-4 text-xs"
      style="color: var(--color-gray-accent)"
    >
      <p>
        Vibe coded by
        <a
          href="https://gemini.google.com"
          target="_blank"
          rel="noopener noreferrer"
          class="underline transition-colors"
          style="color: var(--color-fg-dark)"
          onmouseover="this.style.color='var(--color-fg-light)'"
          onmouseout="this.style.color='var(--color-fg-dark)'"
        >
          Gemini
        </a>
        - Based on
        <a
          href="https://github.com/uheej0625/copilot-usage-viewer"
          target="_blank"
          rel="noopener noreferrer"
          class="underline transition-colors"
          style="color: var(--color-fg-dark)"
          onmouseover="this.style.color='var(--color-fg-light)'"
          onmouseout="this.style.color='var(--color-fg-dark)'"
        >
          copilot-usage-viewer</a
        >
      </p>
    </footer>
  </body>
</html>
