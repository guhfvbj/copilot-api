<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Copilot 监控面板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/lucide-react@0.378.0/dist/umd/lucide.min.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['"Plus Jakarta Sans"', "sans-serif"],
              mono: ['"JetBrains Mono"', "monospace"],
            },
            colors: {
              primary: {
                50: "#eff6ff",
                100: "#dbeafe",
                500: "#3b82f6",
                600: "#2563eb",
                700: "#1d4ed8",
              },
            },
            animation: {
              'fade-in': 'fadeIn 0.5s ease-out',
              'slide-up': 'slideUp 0.5s ease-out',
            },
            keyframes: {
              fadeIn: {
                '0%': { opacity: '0' },
                '100%': { opacity: '1' },
              },
              slideUp: {
                '0%': { transform: 'translateY(10px)', opacity: '0' },
                '100%': { transform: 'translateY(0)', opacity: '1' },
              }
            }
          },
        },
      };
    </script>
    <style>
      body {
        background-color: #f3f4f6;
        color: #1e293b;
      }
      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }
      
      .glass-panel {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(226, 232, 240, 0.8);
      }

      .btn-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
        transition: all 0.2s ease;
      }
      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 8px -1px rgba(37, 99, 235, 0.3);
      }
      .btn-primary:active {
        transform: translateY(0);
      }

      .card-hover {
        transition: all 0.3s ease;
      }
      .card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }

      /* Circular Progress */
      .circle-chart {
        width: 80px;
        height: 80px;
      }
      .circle-bg {
        fill: none;
        stroke: #e2e8f0;
        stroke-width: 2.5;
      }
      .circle-progress {
        fill: none;
        stroke-width: 2.5;
        stroke-linecap: round;
        transition: stroke-dasharray 1s ease-out;
      }
    </style>
  </head>
  <body class="min-h-screen flex flex-col">
    <nav class="sticky top-0 z-40 glass-panel border-b border-slate-200">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16 items-center">
          <div class="flex items-center gap-3">
            <div class="p-2 bg-blue-50 rounded-lg">
              <i class="lucide lucide-bot h-6 w-6 text-primary-600"></i>
            </div>
            <div>
              <h1 class="font-bold text-slate-800 text-lg leading-tight">Copilot Dashboard</h1>
              <div class="text-[10px] font-mono text-slate-500 tracking-wider uppercase">Usage Monitor</div>
            </div>
          </div>
          
          <div class="flex items-center gap-3">
            <div id="account-selector-container" class="hidden md:block">
              </div>
            <div class="h-6 w-px bg-slate-200 mx-1 hidden md:block"></div>
            <button id="refresh-btn" class="p-2 text-slate-500 hover:text-primary-600 hover:bg-blue-50 rounded-lg transition-colors" title="刷新数据">
              <i class="lucide lucide-refresh-cw h-5 w-5"></i>
            </button>
            <button id="add-account-btn" class="btn-primary text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
              <i class="lucide lucide-plus h-4 w-4"></i>
              <span class="hidden sm:inline">添加账号</span>
            </button>
          </div>
        </div>
      </div>
    </nav>

    <div class="md:hidden px-4 py-3 bg-white border-b border-slate-200" id="mobile-selector-container">
        </div>

    <main class="flex-1 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full space-y-8">
      
      <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="h-8 w-8 rounded-full bg-green-50 flex items-center justify-center border border-green-100">
                <div class="h-2.5 w-2.5 rounded-full bg-green-500 animate-pulse"></div>
            </div>
            <div>
                <div class="text-xs text-slate-500">API Endpoint</div>
                <div class="font-mono text-sm text-slate-700 font-medium" id="current-endpoint">...</div>
            </div>
        </div>
        <div class="flex items-center gap-2 text-xs text-slate-400 bg-slate-50 px-3 py-1.5 rounded-md border border-slate-100">
            <i class="lucide lucide-shield-check h-3 w-3"></i>
            <span>Secure Connection</span>
        </div>
      </div>

      <div id="content-area" class="space-y-8 min-h-[400px]">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 animate-pulse">
            <div class="h-40 bg-slate-200 rounded-xl"></div>
            <div class="h-40 bg-slate-200 rounded-xl"></div>
            <div class="h-40 bg-slate-200 rounded-xl"></div>
        </div>
      </div>

    </main>

    <footer class="py-6 text-center text-sm text-slate-400">
      <p>&copy; 2024 Copilot Usage Dashboard</p>
    </footer>

    <div id="add-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
      <div class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity opacity-0" id="modal-backdrop"></div>

      <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
          <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" id="modal-panel">
            <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
              <div class="sm:flex sm:items-start">
                <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                  <i class="lucide lucide-key h-5 w-5 text-blue-600"></i>
                </div>
                <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                  <h3 class="text-lg font-semibold leading-6 text-slate-900" id="modal-title">添加新账号</h3>
                  <div class="mt-2">
                    <p class="text-sm text-slate-500 mb-4">请输入 GitHub Token 以添加新的 Copilot 账号到监控池。</p>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">GitHub Token</label>
                            <input id="token-input" type="text" class="w-full rounded-lg border-slate-300 border shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-2.5 px-3 font-mono" placeholder="ghp_xxxxxxxxxxxx">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">账号类型</label>
                            <div class="relative">
                                <select id="account-type" class="w-full appearance-none rounded-lg border-slate-300 border bg-white py-2.5 px-3 pr-8 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 sm:text-sm">
                                    <option value="individual">Individual (个人)</option>
                                    <option value="business">Business (商业)</option>
                                    <option value="enterprise">Enterprise (企业)</option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500">
                                    <i class="lucide lucide-chevron-down h-4 w-4"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="bg-slate-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 border-t border-slate-100">
              <button id="modal-submit" type="button" class="inline-flex w-full justify-center rounded-lg bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 sm:ml-3 sm:w-auto transition-all">提交添加</button>
              <button id="modal-cancel" type="button" class="mt-3 inline-flex w-full justify-center rounded-lg bg-white px-3 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 hover:bg-slate-50 sm:mt-0 sm:w-auto transition-all">取消</button>
            </div>
            <div id="modal-error" class="bg-red-50 text-red-600 text-xs py-2 px-6 text-center hidden"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const BASE = `${window.location.protocol}//${window.location.host}`;
      const USAGE_URL = `${BASE}/usage`;
      const TOKEN_URL = `${BASE}/token`;
      const ACCOUNT_URL = `${BASE}/accounts`;

      const state = {
        isLoading: false,
        error: null,
        data: null,
        accounts: [],
        accountId: "",
      };

      // DOM Elements
      const contentArea = document.getElementById("content-area");
      const refreshBtn = document.getElementById("refresh-btn");
      const addAccountBtn = document.getElementById("add-account-btn");
      const endpointLabel = document.getElementById("current-endpoint");
      const accountSelectorContainer = document.getElementById("account-selector-container");
      const mobileSelectorContainer = document.getElementById("mobile-selector-container");
      
      // Modal Elements
      const modal = document.getElementById("add-modal");
      const modalBackdrop = document.getElementById("modal-backdrop");
      const modalPanel = document.getElementById("modal-panel");
      const modalError = document.getElementById("modal-error");

      // --- Rendering Helpers ---

      function createIcons() {
        if (typeof lucide !== "undefined") lucide.createIcons();
      }

      function getCircularProgress(percentage, colorClass) {
        const radius = 32;
        const circumference = radius * 2 * Math.PI;
        const offset = circumference - (percentage / 100) * circumference;
        
        let strokeColor = "#3b82f6"; // blue-500
        if (colorClass.includes("orange")) strokeColor = "#f97316";
        if (colorClass.includes("red")) strokeColor = "#dc2626";
        if (colorClass.includes("green")) strokeColor = "#22c55e";

        return `
            <svg class="circle-chart transform -rotate-90" viewBox="0 0 72 72">
                <circle class="circle-bg" cx="36" cy="36" r="${radius}"></circle>
                <circle class="circle-progress" cx="36" cy="36" r="${radius}" 
                    stroke-dasharray="${circumference}" 
                    stroke-dashoffset="${offset}"
                    stroke="${strokeColor}"
                ></circle>
            </svg>
        `;
      }

      function renderAccountSelector() {
        const count = state.accounts.length;
        if (count === 0) {
            accountSelectorContainer.innerHTML = '';
            mobileSelectorContainer.innerHTML = '';
            mobileSelectorContainer.classList.add('hidden');
            return;
        }

        const options = state.accounts
          .map((acc) =>`<option value="${acc.id}" ${state.accountId === acc.id ? "selected" : ""}>${acc.id} (${acc.accountType || 'Unknown'})</option>`)
          .join("");

        const selectorHTML = `
            <div class="relative group">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="lucide lucide-user h-4 w-4 text-slate-400"></i>
                </div>
                <select id="account-select-desktop" class="bg-white border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-9 pr-8 py-2 appearance-none shadow-sm cursor-pointer hover:border-blue-300 transition-colors">
                    <option value="">Auto (Default)</option>
                    ${options}
                </select>
                <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-slate-400">
                    <i class="lucide lucide-chevron-down h-3 w-3"></i>
                </div>
            </div>
        `;
        
        // Desktop
        accountSelectorContainer.innerHTML = selectorHTML;
        const deskSelect = document.getElementById("account-select-desktop");
        if(deskSelect) {
            deskSelect.onchange = (e) => {
                state.accountId = e.target.value;
                fetchAll();
            };
        }

        // Mobile
        mobileSelectorContainer.classList.remove('hidden');
        mobileSelectorContainer.innerHTML = selectorHTML.replace('account-select-desktop', 'account-select-mobile');
        const mobSelect = document.getElementById("account-select-mobile");
        if(mobSelect) {
             mobSelect.onchange = (e) => {
                state.accountId = e.target.value;
                fetchAll();
            };
        }
      }

      function renderError(message) {
        return `
          <div class="rounded-xl border border-red-200 bg-red-50 p-8 text-center animate-fade-in">
            <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-red-100 mb-4">
              <i class="lucide lucide-alert-triangle h-6 w-6 text-red-600"></i>
            </div>
            <h3 class="text-lg font-semibold text-red-900">无法获取数据</h3>
            <p class="mt-2 text-sm text-red-700 max-w-md mx-auto">${message}</p>
            <button onclick="fetchAll()" class="mt-4 text-sm font-medium text-red-600 hover:text-red-800 underline">重试</button>
          </div>
        `;
      }

      function renderSpinner() {
        return `
          <div class="flex flex-col items-center justify-center py-20 animate-fade-in">
            <div class="relative">
                <div class="h-16 w-16 rounded-full border-4 border-slate-200"></div>
                <div class="absolute top-0 left-0 h-16 w-16 rounded-full border-4 border-blue-500 border-t-transparent animate-spin"></div>
            </div>
            <p class="mt-4 text-slate-500 font-medium animate-pulse">正在同步数据...</p>
          </div>
        `;
      }

      function renderQuotaCard(title, detail) {
        const { entitlement, remaining, percent_remaining, unlimited } = detail;
        const percentUsed = unlimited ? 0 : 100 - percent_remaining;
        const used = unlimited ? 0 : entitlement - remaining;
        
        let colorClass = "text-blue-600";
        if (!unlimited && percentUsed > 75) colorClass = "text-orange-500";
        if (!unlimited && percentUsed > 90) colorClass = "text-red-600";
        if (unlimited) colorClass = "text-green-500";

        const iconMap = {
            chat: 'message-square',
            completions: 'code-2',
            premium_interactions: 'sparkles'
        };
        const iconName = iconMap[title] || 'activity';

        return `
          <div class="bg-white rounded-xl p-5 border border-slate-200 shadow-sm card-hover flex flex-col justify-between animate-slide-up">
            <div class="flex justify-between items-start mb-4">
                <div class="flex items-center gap-3">
                    <div class="p-2.5 rounded-lg bg-slate-50 text-slate-600">
                        <i class="lucide lucide-${iconName} h-5 w-5"></i>
                    </div>
                    <div>
                        <div class="text-sm font-semibold text-slate-700 capitalize">${title.replace(/_/g, " ")}</div>
                        <div class="text-xs text-slate-400">Quota Type</div>
                    </div>
                </div>
                ${unlimited 
                    ? `<span class="inline-flex items-center rounded-full bg-green-50 px-2.5 py-0.5 text-xs font-medium text-green-700 ring-1 ring-inset ring-green-600/20">Unlimited</span>`
                    : `<span class="inline-flex items-center rounded-full bg-slate-100 px-2.5 py-0.5 text-xs font-medium text-slate-600">${percentUsed.toFixed(1)}% Used</span>`
                }
            </div>

            <div class="flex items-end justify-between">
                <div>
                    <div class="text-3xl font-bold text-slate-800 tracking-tight">
                        ${unlimited ? '∞' : remaining.toLocaleString()}
                    </div>
                    <div class="text-xs text-slate-500 mt-1 font-mono">
                        Available / ${unlimited ? '∞' : entitlement.toLocaleString()}
                    </div>
                </div>
                
                <div class="relative flex items-center justify-center">
                    ${unlimited 
                        ? `<i class="lucide lucide-infinity h-10 w-10 text-green-200"></i>` 
                        : getCircularProgress(percentUsed, colorClass)
                    }
                </div>
            </div>
          </div>
        `;
      }

      function formatMaybeDate(value) {
        if (typeof value !== "string") return null;
        // Simple check if it looks like a date/timestamp
        if (!value.match(/^\d{4}-\d{2}-\d{2}/) && !value.match(/\d{4}-\d{2}-\d{2}T/)) return null;
        
        const d = new Date(value);
        if (Number.isNaN(d.getTime())) return null;
        
        const pad = (n) => n.toString().padStart(2, "0");
        return `<span title="${value}">${d.getFullYear()}/${pad(d.getMonth() + 1)}/${pad(d.getDate())} <span class="text-slate-400 text-xs">${pad(d.getHours())}:${pad(d.getMinutes())}</span></span>`;
      }

      function formatValue(key, v) {
        if (typeof v === "boolean") {
            return v 
                ? `<span class="inline-flex items-center rounded-md bg-green-50 px-2 py-1 text-xs font-medium text-green-700 ring-1 ring-inset ring-green-600/20">True</span>`
                : `<span class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-xs font-medium text-red-700 ring-1 ring-inset ring-red-600/10">False</span>`;
        }
        if (typeof v === "number") {
             if (key.includes("percent")) return `${v.toFixed(1)}%`;
             return v.toLocaleString();
        }
        if (typeof v === "string") {
            const date = formatMaybeDate(v);
            if (date) return date;
            if (v.startsWith("http")) return `<a href="${v}" target="_blank" class="text-blue-500 hover:underline truncate block max-w-[200px]">${v}</a>`;
            return v;
        }
        return String(v);
      }

      function flattenObject(obj, prefix = '') {
        let result = {};
        for (const [k, v] of Object.entries(obj)) {
            if (k === 'quota_snapshots') continue; // Handled separately
            if (v && typeof v === 'object' && !Array.isArray(v)) {
                const flat = flattenObject(v, prefix ? `${prefix}.${k}` : k);
                result = { ...result, ...flat };
            } else {
                result[prefix ? `${prefix}.${k}` : k] = v;
            }
        }
        return result;
      }

      function renderDetailsTable(data) {
        const flatData = flattenObject(data);
        const entries = Object.entries(flatData);
        
        if (entries.length === 0) return '';

        const rows = entries.map(([k, v]) => {
            const label = k.split('.').pop().replace(/_/g, " ").replace(/([A-Z])/g, ' $1').trim();
            const value = Array.isArray(v) ? `[ ${v.length} items ]` : formatValue(k, v);
            
            return `
                <div class="flex flex-col p-3 hover:bg-slate-50 rounded-lg transition-colors border border-transparent hover:border-slate-100">
                    <dt class="text-xs font-medium text-slate-500 uppercase tracking-wider mb-1">${label}</dt>
                    <dd class="text-sm text-slate-800 font-mono break-all">${value}</dd>
                </div>
            `;
        }).join("");

        return `
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden animate-slide-up" style="animation-delay: 0.1s;">
                <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex items-center gap-2">
                    <i class="lucide lucide-database h-4 w-4 text-slate-400"></i>
                    <h3 class="font-semibold text-slate-700">Meta Information</h3>
                </div>
                <div class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                    ${rows}
                </div>
            </div>
        `;
      }

      // --- Main Logic ---

      async function fetchAccounts() {
        try {
          const res = await fetch(ACCOUNT_URL);
          if (res.ok) {
            const json = await res.json();
            if (Array.isArray(json.accounts)) {
              state.accounts = json.accounts.map((a) => ({
                id: a.id || "unknown",
                accountType: a.accountType,
              }));
            }
          }
          // fallback
          if (!state.accounts.length) {
            const tRes = await fetch(TOKEN_URL);
            if (tRes.ok) {
              const json = await tRes.json();
              if (Array.isArray(json.tokens)) {
                state.accounts = json.tokens.map((t) => ({
                  id: t.id || "unknown",
                  accountType: t.accountType,
                }));
              }
            }
          }
          if (!state.accountId && state.accounts.length > 0) {
            state.accountId = state.accounts[0].id;
          }
        } catch (e) {
          console.warn("账户列表获取失败:", e);
        }
      }

      async function addAccount(githubToken, accountType) {
        const res = await fetch(ACCOUNT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ githubToken, accountType }),
        });
        if (!res.ok) {
          throw new Error(`Error: ${res.status}`);
        }
        return res.json();
      }

      async function fetchUsage() {
        const headers = {};
        if (state.accountId) headers["X-Account-Id"] = state.accountId;
        const res = await fetch(USAGE_URL, { headers });
        if (!res.ok) throw new Error(`API Error ${res.status}: ${res.statusText}`);
        return res.json();
      }

      async function fetchAll() {
        state.isLoading = true;
        state.error = null;
        render(); // show loading
        
        try {
          await fetchAccounts();
          renderAccountSelector();
          const data = await fetchUsage();
          state.data = data;
        } catch (err) {
          state.error = err.message || "Failed to fetch";
          state.data = null;
        } finally {
          state.isLoading = false;
          render();
        }
      }

      function render() {
        // 1. Loading
        if (state.isLoading) {
          contentArea.innerHTML = renderSpinner();
          createIcons();
          return;
        }

        // 2. Error
        if (state.error) {
          contentArea.innerHTML = renderError(state.error);
          createIcons();
          return;
        }

        // 3. Data
        if (state.data) {
          let cardsHtml = '';
          if (state.data.quota_snapshots) {
            cardsHtml = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${Object.entries(state.data.quota_snapshots)
                        .map(([key, value]) => renderQuotaCard(key, value))
                        .join("")}
                </div>
            `;
          } else {
             cardsHtml = `
                <div class="p-8 text-center bg-white rounded-xl border border-dashed border-slate-300">
                    <p class="text-slate-500">No quota snapshots available.</p>
                </div>
             `;
          }

          contentArea.innerHTML = `
            ${state.data.account ? 
                `<div class="flex items-center gap-2 mb-4 animate-fade-in">
                    <span class="inline-flex items-center rounded-md bg-blue-50 px-2 py-1 text-xs font-medium text-blue-700 ring-1 ring-inset ring-blue-700/10">Active Account</span>
                    <span class="text-sm font-mono text-slate-600">${state.data.account}</span>
                 </div>` : ''}
            
            ${cardsHtml}
            ${renderDetailsTable(state.data)}
          `;
          createIcons();
          return;
        }

        // 4. Empty / Init State
        contentArea.innerHTML = `
          <div class="rounded-xl bg-white border border-slate-200 p-12 text-center shadow-sm">
             <div class="mx-auto h-24 w-24 bg-slate-50 rounded-full flex items-center justify-center mb-4">
                 <i class="lucide lucide-layout-dashboard h-10 w-10 text-slate-300"></i>
             </div>
             <h3 class="text-lg font-semibold text-slate-900">Dashboard Ready</h3>
             <p class="text-slate-500 mt-2">Click refresh to load your Copilot usage data.</p>
          </div>
        `;
        createIcons();
      }

      // --- Modal Logic ---
      function toggleModal(show) {
        if (show) {
            modal.classList.remove("hidden");
            // Small delay for transition
            setTimeout(() => {
                modalBackdrop.classList.remove("opacity-0");
                modalPanel.classList.remove("opacity-0", "translate-y-4", "sm:translate-y-0", "sm:scale-95");
                modalPanel.classList.add("opacity-100", "translate-y-0", "sm:scale-100");
            }, 10);
        } else {
            modalBackdrop.classList.add("opacity-0");
            modalPanel.classList.add("opacity-0", "translate-y-4", "sm:translate-y-0", "sm:scale-95");
            modalPanel.classList.remove("opacity-100", "translate-y-0", "sm:scale-100");
            setTimeout(() => {
                modal.classList.add("hidden");
                modalError.classList.add("hidden");
                document.getElementById("token-input").value = "";
            }, 300);
        }
      }

      function initModal() {
        document.getElementById("modal-cancel").onclick = () => toggleModal(false);
        addAccountBtn.onclick = () => toggleModal(true);
        
        // Close on backdrop click
        modal.onclick = (e) => {
            if (e.target === modal || e.target.parentElement === modal) toggleModal(false);
        };

        document.getElementById("modal-submit").onclick = async () => {
          const tokenInput = document.getElementById("token-input");
          const typeInput = document.getElementById("account-type");
          const btn = document.getElementById("modal-submit");
          
          const token = tokenInput.value.trim();
          const type = typeInput.value;
          
          modalError.classList.add("hidden");
          
          if (!token) {
            modalError.textContent = "Please enter a valid GitHub Token";
            modalError.classList.remove("hidden");
            return;
          }

          // Loading state
          const originalBtnText = btn.innerHTML;
          btn.innerHTML = `<i class="lucide lucide-loader-2 h-4 w-4 animate-spin"></i> Processing...`;
          btn.disabled = true;

          try {
            await addAccount(token, type);
            toggleModal(false);
            await fetchAll();
          } catch (err) {
            modalError.textContent = err.message || "Failed to add account";
            modalError.classList.remove("hidden");
          } finally {
            btn.innerHTML = originalBtnText;
            btn.disabled = false;
          }
        };
      }

      // Initialize
      refreshBtn.onclick = fetchAll;
      endpointLabel.textContent = USAGE_URL;
      initModal();
      fetchAll();

    </script>
  </body>
</html>