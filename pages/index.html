<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Copilot 用量面板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/lucide-react@0.378.0/dist/umd/lucide.min.js"></script>
    <style>
      body {
        font-family: "Inter", "PingFang SC", "Microsoft YaHei", sans-serif;
        background: radial-gradient(circle at 20% 20%, #1f2937 0, #0f172a 45%, #0b1223 100%);
        color: #e5e7eb;
      }
      .card {
        backdrop-filter: blur(12px);
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.45);
      }
      .glass {
        backdrop-filter: blur(14px);
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(139, 92, 246, 0.12));
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .progress {
        height: 10px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.08);
        overflow: hidden;
      }
      .progress > div {
        height: 100%;
        border-radius: 999px;
        transition: width 0.4s ease;
        background: linear-gradient(90deg, #22d3ee, #8b5cf6);
      }
      .pill {
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.08);
        font-size: 12px;
        color: #cbd5f5;
      }
      .btn {
        background: linear-gradient(135deg, #22d3ee, #8b5cf6);
        color: #0b1223;
        font-weight: 700;
        border-radius: 12px;
        padding: 10px 16px;
      }
      .btn:active {
        transform: translateY(1px);
      }
      .mono {
        font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
      }
    </style>
  </head>
  <body class="min-h-screen">
    <div class="max-w-6xl mx-auto px-4 py-8 space-y-6">
      <header class="flex flex-col gap-2 card p-6">
        <div class="flex items-center gap-3">
          <div class="p-2 rounded-xl glass">
            <i class="lucide lucide-gauge h-6 w-6 text-cyan-300"></i>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-white">Copilot 用量面板</h1>
            <p class="text-sm text-slate-300">
              直接访问当前域名的 <span class="mono text-cyan-200">/usage</span> 与 <span class="mono text-cyan-200">/token</span>
            </p>
          </div>
        </div>
      </header>

      <section class="card p-5 space-y-4">
        <div class="flex flex-col sm:flex-row sm:items-center gap-3">
          <div class="flex items-center gap-2">
            <i class="lucide lucide-server h-5 w-5 text-cyan-300"></i>
            <div>
              <div class="text-xs uppercase tracking-wide text-slate-400">请求地址</div>
              <div class="mono text-sm text-cyan-100" id="current-endpoint"></div>
            </div>
          </div>
          <div class="flex-1"></div>
          <button id="refresh-btn" class="btn flex items-center gap-2 self-start">
            <i class="lucide lucide-refresh-cw h-4 w-4"></i>
            <span>刷新</span>
          </button>
        </div>
        <div id="account-selector"></div>
      </section>

      <div id="content-area" class="space-y-4"></div>
    </div>

    <script>
      // 固定使用当前域名，确保 Nginx 反代同域部署
      const BASE = `${window.location.protocol}//${window.location.host}`;
      const USAGE_URL = `${BASE}/usage`;
      const TOKEN_URL = `${BASE}/token`;

      const state = {
        isLoading: false,
        error: null,
        data: null,
        accounts: [],
        accountId: "",
      };

      const contentArea = document.getElementById("content-area");
      const refreshBtn = document.getElementById("refresh-btn");
      const endpointLabel = document.getElementById("current-endpoint");
      const accountSelectorSlot = document.getElementById("account-selector");

      function createIcons() {
        if (typeof lucide !== "undefined") lucide.createIcons();
      }

      function renderAccountSelector() {
        if (!state.accounts.length) {
          accountSelectorSlot.innerHTML = "";
          return;
        }
        const options = state.accounts
          .map(
            (acc) =>
              `<option value="${acc.id}" ${state.accountId === acc.id ? "selected" : ""}>${acc.id}</option>`,
          )
          .join("");
        accountSelectorSlot.innerHTML = `
          <label class="flex items-center gap-2 text-sm text-slate-200">
            <i class="lucide lucide-users h-4 w-4 text-cyan-300"></i>
            <span>选择账号</span>
            <select id="account-select" class="bg-slate-900/70 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-cyan-400">
              <option value="">自动(首账号)</option>
              ${options}
            </select>
          </label>
        `;
        const select = document.getElementById("account-select");
        select.onchange = () => {
          state.accountId = select.value;
          fetchAll();
        };
      }

      function renderError(message) {
        return `
          <div class="card border border-red-500/40 bg-red-500/10 p-5">
            <div class="flex items-center gap-2 text-red-300 font-semibold">
              <i class="lucide lucide-alert-triangle h-5 w-5"></i>
              <span>请求失败</span>
            </div>
            <div class="mt-2 text-sm text-red-200">${message}</div>
          </div>
        `;
      }

      function renderSpinner() {
        return `
          <div class="card p-6 flex justify-center">
            <div class="animate-spin h-10 w-10 rounded-full border-4 border-slate-700 border-t-cyan-300"></div>
          </div>
        `;
      }

      function renderQuotaCard(title, detail) {
        const { entitlement, remaining, percent_remaining, unlimited } = detail;
        const percentUsed = unlimited ? 0 : 100 - percent_remaining;
        const used = unlimited ? "N/A" : entitlement - remaining;
        let color = "from-cyan-400 to-blue-500";
        if (!unlimited && percentUsed > 75) color = "from-amber-400 to-orange-500";
        if (!unlimited && percentUsed > 90) color = "from-rose-500 to-red-600";
        return `
          <div class="card p-4 space-y-3">
            <div class="flex justify-between items-center">
              <div class="text-sm text-slate-300 capitalize">${title.replace(/_/g, " ")}</div>
              <span class="pill">${unlimited ? "无限" : percentUsed.toFixed(1) + "% 已用"}</span>
            </div>
            <div class="progress">
              <div style="width:${unlimited ? 100 : percentUsed}%;" class="bg-gradient-to-r ${color}"></div>
            </div>
            <div class="flex justify-between text-xs text-slate-400 mono">
              <span>${used.toLocaleString()} / ${unlimited ? "N/A" : entitlement.toLocaleString()}</span>
              <span>${unlimited ? "N/A" : remaining.toLocaleString()} 剩余</span>
            </div>
          </div>
        `;
      }

      function formatObject(obj) {
        if (obj === null || typeof obj !== "object") {
          return `<span class="text-cyan-200">${JSON.stringify(obj)}</span>`;
        }
        const entries = Object.entries(obj)
          .map(([k, v]) => {
            const label = k.replace(/_/g, " ");
            let val;
            if (Array.isArray(v)) {
              val = `<span class="text-slate-400">[ ${v.length} items ]</span>`;
            } else if (typeof v === "object") {
              val = formatObject(v);
            } else if (typeof v === "boolean") {
              val = `<span class="${v ? "text-green-300" : "text-red-300"} font-semibold">${v}</span>`;
            } else {
              val = `<span class="text-blue-200">${JSON.stringify(v)}</span>`;
            }
            return `
              <div class="flex flex-col gap-1">
                <span class="text-slate-300 text-sm">${label}:</span>
                <div class="pl-3 text-sm">${val}</div>
              </div>
            `;
          })
          .join("");
        return `<div class="space-y-2">${entries}</div>`;
      }

      function renderDetailed(data) {
        return `
          <div class="card p-5 space-y-3">
            <div class="flex items-center gap-2 text-slate-200">
              <i class="lucide lucide-file-text h-5 w-5 text-cyan-300"></i>
              <span class="font-semibold">完整数据</span>
            </div>
            <div class="mono text-xs text-slate-200 space-y-2">${formatObject(data)}</div>
          </div>
        `;
      }

      function renderUsage(data) {
        if (!data?.quota_snapshots) return "";
        const cards = Object.entries(data.quota_snapshots)
          .map(([key, value]) => renderQuotaCard(key, value))
          .join("");
        return `
          <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
            ${cards}
          </div>
        `;
      }

      async function fetchAccounts() {
        try {
          const res = await fetch(TOKEN_URL);
          if (!res.ok) return;
          const json = await res.json();
          if (Array.isArray(json.tokens)) {
            state.accounts = json.tokens.map((t) => ({ id: t.id || "unknown" }));
            if (!state.accountId && state.accounts.length > 0) {
              state.accountId = state.accounts[0].id;
            }
          }
        } catch (e) {
          console.warn("账户列表获取失败:", e);
        }
      }

      async function fetchUsage() {
        const headers = {};
        if (state.accountId) headers["X-Account-Id"] = state.accountId;
        const res = await fetch(USAGE_URL, { headers });
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        return res.json();
      }

      async function fetchAll() {
        state.isLoading = true;
        state.error = null;
        render();
        try {
          await fetchAccounts();
          renderAccountSelector();
          const data = await fetchUsage();
          state.data = data;
        } catch (err) {
          state.error = err.message || "Failed to fetch";
          state.data = null;
        } finally {
          state.isLoading = false;
          render();
        }
      }

      function render() {
        if (state.isLoading) {
          contentArea.innerHTML = renderSpinner();
          createIcons();
          return;
        }
        if (state.error) {
          contentArea.innerHTML = renderError(state.error);
          createIcons();
          return;
        }
        if (state.data) {
          const accountInfo = state.data.account
            ? `<div class="text-sm text-slate-300">当前账号：<span class="mono text-cyan-200">${state.data.account}</span></div>`
            : "";
          contentArea.innerHTML = `
            <div class="flex flex-col lg:flex-row gap-4">
              <div class="flex-1 space-y-4">
                ${accountInfo}
                ${renderUsage(state.data)}
              </div>
            </div>
            ${renderDetailed(state.data)}
          `;
          createIcons();
          return;
        }
        contentArea.innerHTML = `
          <div class="card p-6 text-center text-slate-300">
            <div class="flex justify-center mb-2">
              <i class="lucide lucide-info h-6 w-6 text-cyan-300"></i>
            </div>
            <p>点击右上角「刷新」获取最新用量</p>
          </div>
        `;
        createIcons();
      }

      refreshBtn.onclick = fetchAll;
      endpointLabel.textContent = USAGE_URL;
      fetchAll();
    </script>
  </body>
</html>
